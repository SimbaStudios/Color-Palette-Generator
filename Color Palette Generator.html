<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Color Palette Generator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the Inter font and overall aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }
        /* Style for the color box displayed on screen */
        .color-box {
            width: 100%;
            height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #ffffff; /* Default text color for hex codes */
            cursor: pointer;
            border-radius: 0.5rem; /* Rounded corners for color boxes */
            transition: transform 0.2s ease-in-out;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.4); /* Add shadow for better readability on various backgrounds */
        }
        .color-box:hover {
            transform: scale(1.02); /* Slight scale up on hover */
        }

        /* Custom modal for messages */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* Style for color input when it's just a picker */
        input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border: none;
            width: 32px;
            height: 32px;
            cursor: pointer;
            border-radius: 0.25rem; /* Slightly rounded */
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 0.25rem;
        }
        input[type="color"]::-moz-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-moz-color-swatch {
            border: none;
            border-radius: 0.25rem;
        }

        /* Common generator section styles */
        .generator-section {
            background-color: #ffffff;
            padding: 1.5rem 2.5rem; /* p-6 sm:p-10 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            width: 100%;
            max-width: 900px; /* max-w-4xl */
            margin-top: 2rem; /* mt-8 */
            display: none; /* Hidden by default */
        }

        /* Styles for drag-and-drop */
        .draggable-item {
            cursor: grab;
        }
        .draggable-item.dragging {
            opacity: 0.5;
            border: 2px dashed #999;
        }
        .drag-handle {
            cursor: grab;
            font-size: 1.5rem; /* Larger handle for easier grabbing */
            line-height: 1;
        }
        .color-preview-canvas {
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>

    <!-- Home Screen -->
    <div id="homeScreen" class="generator-section block">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-800 mb-6 text-center">Welcome to the Color Palette Generator!</h1>
        <p class="text-gray-600 mb-8 max-w-xl mx-auto text-center">
            Choose a generation method below to get started:
        </p>
        <div class="flex flex-col gap-4">
            <button
                id="startRandomButton"
                class="px-8 py-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-bold rounded-lg shadow-md hover:from-blue-600 hover:to-indigo-700 transition duration-300 ease-in-out text-xl"
            >
                Generate Random Palette
            </button>
            <button
                id="startNatureButton"
                class="px-8 py-4 bg-gradient-to-r from-emerald-500 to-green-600 text-white font-bold rounded-lg shadow-md hover:from-emerald-600 hover:to-green-700 transition duration-300 ease-in-out text-xl"
            >
                Generate Nature Palette
            </button>
            <button
                id="startCustomButton"
                class="px-8 py-4 bg-gradient-to-r from-orange-500 to-red-600 text-white font-bold rounded-lg shadow-md hover:from-orange-600 hover:to-red-700 transition duration-300 ease-in-out text-xl"
            >
                Create Custom Palette
            </button>
        </div>
    </div>

    <!-- Random Palette Generator Section -->
    <div id="randomPaletteSection" class="generator-section">
        <div class="flex justify-start mb-6">
            <button
                id="backToHomeRandom"
                class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg shadow-sm hover:bg-gray-400 transition"
            >
                &larr; Back to Home
            </button>
        </div>
        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-6 text-center">Random Palette Generator</h1>
        <p class="text-gray-600 mb-8 text-center max-w-2xl mx-auto">
            Generate random color palettes with options for even or truly random distribution.
        </p>
        <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-8">
            <input
                type="number"
                id="numColorsRandom"
                min="1"
                value="5"
                class="w-full sm:w-auto p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg"
                aria-label="Number of colors"
            >
            <button
                id="generateRandomButton"
                class="w-full sm:w-auto px-6 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold rounded-lg shadow-md hover:from-blue-600 hover:to-indigo-700 transition duration-300 ease-in-out text-lg"
            >
                Generate Random Palette
            </button>
        </div>
        <div class="flex items-center justify-center gap-2 mb-8">
            <input
                type="checkbox"
                id="trulyRandomColorsRandom"
                class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500"
                aria-label="Generate truly random colors (uneven distribution)"
            >
            <label for="trulyRandomColorsRandom" class="text-gray-700">Truly Random Colors (Uneven Distribution)</label>
        </div>


        <!-- Download Options and Current Palette Sections (Common) -->
        <div class="flex flex-col gap-4 mb-8 border border-gray-200 p-4 rounded-xl bg-gray-50 shadow-sm">
            <h2 class="text-xl font-semibold text-gray-700 text-center">Download Options</h2>
            <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                <div class="flex flex-col sm:flex-row items-center gap-2">
                    <label for="imageBoxWidth" class="text-gray-700 whitespace-nowrap">Image Block Width (px):</label>
                    <input
                        type="number"
                        id="imageBoxWidth"
                        min="50"
                        value="200"
                        class="w-full sm:w-24 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-base"
                        aria-label="Image block width"
                    >
                </div>
                <div class="flex flex-col sm:flex-row items-center gap-2">
                    <label for="imageBoxHeight" class="text-gray-700 whitespace-nowrap">Image Block Height (px):</label>
                    <input
                        type="number"
                        id="imageBoxHeight"
                        min="50"
                        value="120"
                        class="w-full sm:w-24 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-base"
                        aria-label="Image block height"
                    >
                </div>
                <div class="flex flex-col sm:flex-row items-center gap-2">
                    <label for="imageColumns" class="text-gray-700 whitespace-nowrap">Columns per row (Grid Image):</label>
                    <input
                        type="number"
                        id="imageColumns"
                        min="1"
                        value="5"
                        class="w-full sm:w-24 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-base"
                        aria-label="Columns per row in downloaded image"
                    >
                </div>
            </div>
            <div class="flex items-center justify-center gap-2 mt-2">
                <input
                    type="checkbox"
                    id="hideHexCodes"
                    class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500"
                    aria-label="Hide hex codes on download"
                >
                <label for="hideHexCodes" class="text-gray-700">Hide Hex Codes on Download</label>
            </div>
            <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mt-4">
                <button
                    id="downloadPaletteButton"
                    class="w-full sm:w-auto px-6 py-3 bg-gradient-to-r from-green-500 to-teal-600 text-white font-semibold rounded-lg shadow-md hover:from-green-600 hover:to-teal-700 transition duration-300 ease-in-out text-lg"
                >
                    Download Palette as Grid Image
                </button>
                <button
                    id="downloadGradientButton"
                    class="w-full sm:w-auto px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-600 text-white font-semibold rounded-lg shadow-md hover:from-purple-600 hover:to-pink-700 transition duration-300 ease-in-out text-lg mt-2 sm:mt-0"
                >
                    Download Palette as Gradient Image
                </button>
            </div>
        </div>

        <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">Current Palette</h2>
        <div id="paletteContainerRandom" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
            <!-- Color boxes will be injected here by JavaScript -->
        </div>
    </div>

    <!-- Nature Palette Generator Section -->
    <div id="naturePaletteSection" class="generator-section">
        <div class="flex justify-start mb-6">
            <button
                id="backToHomeNature"
                class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg shadow-sm hover:bg-gray-400 transition"
            >
                &larr; Back to Home
            </button>
        </div>
        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-6 text-center">Nature Palette Generator</h1>
        <p class="text-gray-600 mb-8 text-center max-w-2xl mx-auto">
            Generate palettes with colors inspired by nature, with an option to randomize order.
        </p>
        <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-8">
            <input
                type="number"
                id="numColorsNature"
                min="1"
                value="5"
                class="w-full sm:w-auto p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg"
                aria-label="Number of colors"
            >
            <button
                id="generateNatureButton"
                class="w-full sm:w-auto px-6 py-3 bg-gradient-to-r from-emerald-500 to-green-600 text-white font-semibold rounded-lg shadow-md hover:from-emerald-600 hover:to-green-700 transition duration-300 ease-in-out text-lg"
            >
                Generate Nature Palette
            </button>
        </div>
        <div class="flex items-center justify-center gap-2 mb-8">
            <input
                type="checkbox"
                id="randomizeNatureOrder"
                class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500"
                aria-label="Randomize order of nature colors"
            >
            <label for="randomizeNatureOrder" class="text-gray-700">Randomize Order of Colors</label>
        </div>

        <!-- Download Options and Current Palette Sections (Common) -->
        <div class="flex flex-col gap-4 mb-8 border border-gray-200 p-4 rounded-xl bg-gray-50 shadow-sm">
            <h2 class="text-xl font-semibold text-gray-700 text-center">Download Options</h2>
            <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                <div class="flex flex-col sm:flex-row items-center gap-2">
                    <label for="imageBoxWidthNature" class="text-gray-700 whitespace-nowrap">Image Block Width (px):</label>
                    <input
                        type="number"
                        id="imageBoxWidthNature"
                        min="50"
                        value="200"
                        class="w-full sm:w-24 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-base"
                        aria-label="Image block width"
                    >
                </div>
                <div class="flex flex-col sm:flex-row items-center gap-2">
                    <label for="imageBoxHeightNature" class="text-gray-700 whitespace-nowrap">Image Block Height (px):</label>
                    <input
                        type="number"
                        id="imageBoxHeightNature"
                        min="50"
                        value="120"
                        class="w-full sm:w-24 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-base"
                        aria-label="Image block height"
                    >
                </div>
                <div class="flex flex-col sm:flex-row items-center gap-2">
                    <label for="imageColumnsNature" class="text-gray-700 whitespace-nowrap">Columns per row (Grid Image):</label>
                    <input
                        type="number"
                        id="imageColumnsNature"
                        min="1"
                        value="5"
                        class="w-full sm:w-24 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-base"
                        aria-label="Columns per row in downloaded image"
                    >
                </div>
            </div>
            <div class="flex items-center justify-center gap-2 mt-2">
                <input
                    type="checkbox"
                    id="hideHexCodesNature"
                    class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500"
                    aria-label="Hide hex codes on download"
                >
                <label for="hideHexCodesNature" class="text-gray-700">Hide Hex Codes on Download</label>
            </div>
            <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mt-4">
                <button
                    id="downloadPaletteButtonNature"
                    class="w-full sm:w-auto px-6 py-3 bg-gradient-to-r from-green-500 to-teal-600 text-white font-semibold rounded-lg shadow-md hover:from-green-600 hover:to-teal-700 transition duration-300 ease-in-out text-lg"
                >
                    Download Palette as Grid Image
                </button>
                <button
                    id="downloadGradientButtonNature"
                    class="w-full sm:w-auto px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-600 text-white font-semibold rounded-lg shadow-md hover:from-purple-600 hover:to-pink-700 transition duration-300 ease-in-out text-lg mt-2 sm:mt-0"
                >
                    Download Palette as Gradient Image
                </button>
            </div>
        </div>
        <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">Current Palette</h2>
        <div id="paletteContainerNature" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
            <!-- Color boxes will be injected here by JavaScript -->
        </div>
    </div>


    <!-- Custom Palette Generator Section -->
    <div id="customPaletteSection" class="generator-section">
        <div class="flex justify-start mb-6">
            <button
                id="backToHomeCustom"
                class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg shadow-sm hover:bg-gray-400 transition"
            >
                &larr; Back to Home
            </button>
        </div>
        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-6 text-center">Custom Palette Creator</h1>
        <p class="text-gray-600 mb-8 text-center max-w-2xl mx-auto">
            Design your own palette using solid colors and gradient segments. Drag and drop to reorder!
        </p>

        <div class="flex flex-col gap-4 mb-8 border border-gray-200 p-4 rounded-xl bg-gray-50 shadow-sm">
            <h2 class="text-xl font-semibold text-gray-700 text-center">Custom Palette Editor</h2>
            <div id="customPaletteInputs" class="flex flex-col gap-3">
                <!-- Custom color/gradient inputs will be added here -->
            </div>
            <div class="flex flex-col sm:flex-row justify-center gap-4 mt-2">
                <button id="addSolidColorButton" class="px-4 py-2 bg-blue-400 text-white rounded-lg shadow hover:bg-blue-500 transition text-base">Add Solid Color</button>
                <button id="addGradientSegmentButton" class="px-4 py-2 bg-purple-400 text-white rounded-lg shadow hover:bg-purple-500 transition text-base">Add Gradient Segment</button>
            </div>
            <button
                id="generateCustomButton"
                class="w-full px-6 py-3 bg-gradient-to-r from-orange-500 to-red-600 text-white font-semibold rounded-lg shadow-md hover:from-orange-600 hover:to-red-700 transition duration-300 ease-in-out text-lg mt-4"
            >
                Generate Custom Palette
            </button>
        </div>

        <!-- Download Options and Current Palette Sections (Common) -->
        <div class="flex flex-col gap-4 mb-8 border border-gray-200 p-4 rounded-xl bg-gray-50 shadow-sm">
            <h2 class="text-xl font-semibold text-gray-700 text-center">Download Options</h2>
            <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                <div class="flex flex-col sm:flex-row items-center gap-2">
                    <label for="imageBoxWidthCustom" class="text-gray-700 whitespace-nowrap">Image Block Width (px):</label>
                    <input
                        type="number"
                        id="imageBoxWidthCustom"
                        min="50"
                        value="200"
                        class="w-full sm:w-24 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-base"
                        aria-label="Image block width"
                    >
                </div>
                <div class="flex flex-col sm:flex-row items-center gap-2">
                    <label for="imageBoxHeightCustom" class="text-gray-700 whitespace-nowrap">Image Block Height (px):</label>
                    <input
                        type="number"
                        id="imageBoxHeightCustom"
                        min="50"
                        value="120"
                        class="w-full sm:w-24 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-base"
                        aria-label="Image block height"
                    >
                </div>
                <div class="flex flex-col sm:flex-row items-center gap-2">
                    <label for="imageColumnsCustom" class="text-gray-700 whitespace-nowrap">Columns per row (Grid Image):</label>
                    <input
                        type="number"
                        id="imageColumnsCustom"
                        min="1"
                        value="5"
                        class="w-full sm:w-24 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-base"
                        aria-label="Columns per row in downloaded image"
                    >
                </div>
            </div>
            <div class="flex items-center justify-center gap-2 mt-2">
                <input
                    type="checkbox"
                    id="hideHexCodesCustom"
                    class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500"
                    aria-label="Hide hex codes on download"
                >
                <label for="hideHexCodesCustom" class="text-gray-700">Hide Hex Codes on Download</label>
            </div>
            <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mt-4">
                <button
                    id="downloadPaletteButtonCustom"
                    class="w-full sm:w-auto px-6 py-3 bg-gradient-to-r from-green-500 to-teal-600 text-white font-semibold rounded-lg shadow-md hover:from-green-600 hover:to-teal-700 transition duration-300 ease-in-out text-lg"
                >
                    Download Palette as Grid Image
                </button>
                <button
                    id="downloadGradientButtonCustom"
                    class="w-full sm:w-auto px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-600 text-white font-semibold rounded-lg shadow-md hover:from-purple-600 hover:to-pink-700 transition duration-300 ease-in-out text-lg mt-2 sm:mt-0"
                >
                    Download Palette as Gradient Image
                </button>
            </div>
        </div>

        <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">Current Palette</h2>
        <div id="paletteContainerCustom" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
            <!-- Color boxes will be injected here by JavaScript -->
        </div>
    </div>


    <!-- Custom Modal for messages -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeModalButton">&times;</span>
            <p id="modalMessage" class="text-gray-700 text-lg"></p>
        </div>
    </div>

    <script>
        // --- HTML Element References ---
        const homeScreen = document.getElementById('homeScreen');

        // Random Palette Section Elements
        const randomPaletteSection = document.getElementById('randomPaletteSection');
        const backToHomeRandom = document.getElementById('backToHomeRandom');
        const numColorsRandomInput = document.getElementById('numColorsRandom');
        const generateRandomButton = document.getElementById('generateRandomButton');
        const trulyRandomColorsRandomCheckbox = document.getElementById('trulyRandomColorsRandom');
        const paletteContainerRandom = document.getElementById('paletteContainerRandom');

        // Nature Palette Section Elements
        const naturePaletteSection = document.getElementById('naturePaletteSection');
        const backToHomeNature = document.getElementById('backToHomeNature');
        const numColorsNatureInput = document.getElementById('numColorsNature');
        const generateNatureButton = document.getElementById('generateNatureButton');
        const randomizeNatureOrderCheckbox = document.getElementById('randomizeNatureOrder');
        const paletteContainerNature = document.getElementById('paletteContainerNature');

        // Custom Palette Section Elements
        const customPaletteSection = document.getElementById('customPaletteSection');
        const backToHomeCustom = document.getElementById('backToHomeCustom');
        const customPaletteInputs = document.getElementById('customPaletteInputs');
        const addSolidColorButton = document.getElementById('addSolidColorButton');
        const addGradientSegmentButton = document.getElementById('addGradientSegmentButton');
        const generateCustomButton = document.getElementById('generateCustomButton');
        const paletteContainerCustom = document.getElementById('paletteContainerCustom');

        // Common Download Options Elements (each section has its own set of these with unique IDs)
        const imageBoxWidthInputRandom = document.getElementById('imageBoxWidth'); // Random section's
        const imageBoxHeightInputRandom = document.getElementById('imageBoxHeight');
        const imageColumnsInputRandom = document.getElementById('imageColumns');
        const hideHexCodesCheckboxRandom = document.getElementById('hideHexCodes');
        const downloadPaletteButtonRandom = document.getElementById('downloadPaletteButton');
        const downloadGradientButtonRandom = document.getElementById('downloadGradientButton');

        const imageBoxWidthInputNature = document.getElementById('imageBoxWidthNature'); // Nature section's
        const imageBoxHeightInputNature = document.getElementById('imageBoxHeightNature');
        const imageColumnsInputNature = document.getElementById('imageColumnsNature');
        const hideHexCodesCheckboxNature = document.getElementById('hideHexCodesNature');
        const downloadPaletteButtonNature = document.getElementById('downloadPaletteButtonNature');
        const downloadGradientButtonNature = document.getElementById('downloadGradientButtonNature');

        const imageBoxWidthInputCustom = document.getElementById('imageBoxWidthCustom'); // Custom section's
        const imageBoxHeightInputCustom = document.getElementById('imageBoxHeightCustom');
        const imageColumnsInputCustom = document.getElementById('imageColumnsCustom');
        const hideHexCodesCheckboxCustom = document.getElementById('hideHexCodesCustom');
        const downloadPaletteButtonCustom = document.getElementById('downloadPaletteButtonCustom');
        const downloadGradientButtonCustom = document.getElementById('downloadGradientButtonCustom');


        // Home Screen Buttons
        const startRandomButton = document.getElementById('startRandomButton');
        const startNatureButton = document.getElementById('startNatureButton');
        const startCustomButton = document.getElementById('startCustomButton');

        // Modal Elements
        const modal = document.getElementById('myModal');
        const modalMessage = document.getElementById('modalMessage');
        const closeModalButton = document.getElementById('closeModalButton');

        // --- Global State ---
        // generatedColorsArray now stores objects to represent solid colors or gradient segments
        // Each object: { type: 'solid', value: '#HEX' } or { type: 'gradient', start: '#HEX1', end: '#HEX2' }
        let generatedColorsArray = [];
        let customInputCounter = 0; // To ensure unique IDs for custom inputs

        // Global variable to store the item being dragged for custom palette
        let draggedItem = null;

        // --- Nature Colors Definition ---
        const natureColors = [
            '#4A6B3C', '#8B4513', '#ADD8E6', '#F0E68C', '#7CFC00',
            '#4682B4', '#B0C4DE', '#D2B48C', '#5F9EA0', '#F5DEB3',
            '#228B22', '#CD853F', '#87CEEB', '#EEE8AA', '#6B8E23',
            '#A2CD5A', '#A0522D', '#8B0000', '#2F4F4F', '#DDA0DD'
        ];

        // --- Screen Navigation Functions ---
        /**
         * Shows a specific screen and hides others.
         * @param {HTMLElement} screenToShow - The HTML element of the screen to display.
         */
        function showScreen(screenToShow) {
            homeScreen.style.display = 'none';
            randomPaletteSection.style.display = 'none';
            naturePaletteSection.style.display = 'none';
            customPaletteSection.style.display = 'none';

            screenToShow.style.display = 'block'; // Or 'flex' if it's a flex container
        }

        // --- Modal Functions ---
        /**
         * Shows a custom modal message to the user.
         * @param {string} message - The message to display in the modal.
         */
        function showModal(message) {
            modalMessage.textContent = message;
            modal.style.display = 'flex'; // Use flex to center the modal content
        }

        /**
         * Hides the custom modal.
         */
        function hideModal() {
            modal.style.display = 'none';
        }

        // --- Utility Functions ---
        /**
         * Copies text to the clipboard.
         * @param {string} text - The text to copy.
         */
        function copyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showModal(`Copied "${text}" to clipboard!`);
            } catch (err) {
                console.error('Failed to copy text:', err);
                showModal('Failed to copy. Please try again.');
            } finally {
                document.body.removeChild(textArea);
            }
        }

        /**
         * Converts HSL color values to a hexadecimal color string.
         * H, S, L values are percentages.
         * @param {number} h - Hue (0-360).
         * @param {number} s - Saturation (0-100).
         * @param {number} l - Lightness (0-100).
         * @returns {string} Hexadecimal color string (e.g., "#RRGGBB").
         */
        function hslToHex(h, s, l) {
            l /= 100;
            const a = s * Math.min(l, 1 - l) / 100;
            const f = n => {
                const k = (n + h / 30) % 12;
                const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
                return Math.round(255 * color).toString(16).padStart(2, '0'); // convert to hex
            };
            return `#${f(0)}${f(8)}${f(4)}`;
        }

        /**
         * Generates a random hexadecimal color code (truly random, less even distribution).
         * @returns {string} A random hex color string (e.g., "#RRGGBB").
         */
        function getTrulyRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        /**
         * Generates a random hexadecimal color code, favoring even distribution using HSL.
         * @param {number} index - The current index of the color being generated.
         * @param {number} totalColors - The total number of colors to generate.
         * @returns {string} A random hex color string (e.g., "#RRGGBB").
         */
        function getEvenlyDistributedRandomColor(index, totalColors) {
            // Distribute hue evenly across the color wheel
            let hue = (index * (360 / totalColors)) % 360;
            // Add a small random jitter to the hue to prevent perfect linearity and add variation
            hue = (hue + Math.random() * 30 - 15 + 360) % 360; // Jitter by +/- 15 degrees

            // Keep saturation and lightness in a moderate to vibrant range
            const saturation = Math.floor(Math.random() * (80 - 50 + 1)) + 50; // 50-80% saturation
            const lightness = Math.floor(Math.random() * (70 - 40 + 1)) + 40;   // 40-70% lightness

            return hslToHex(hue, saturation, lightness);
        }

        /**
         * Shuffles an array in place using the Fisher-Yates (Knuth) algorithm.
         * @param {Array} array - The array to shuffle.
         * @returns {Array} The shuffled array.
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]]; // Swap elements
            }
            return array;
        }

        /**
         * Determines if a given hex color is dark or light, used for text contrast.
         * @param {string} hexColor - The hex color string (e.g., "#RRGGBB").
         * @returns {boolean} True if the color is dark, false if light.
         */
        function isDarkColor(hexColor) {
            const r = parseInt(hexColor.slice(1, 3), 16);
            const g = parseInt(hexColor.slice(3, 5), 16);
            const b = parseInt(hexColor.slice(5, 7), 16);
            // Calculate luminance using the formula: (0.299*R + 0.587*G + 0.114*B)
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            return luminance < 0.5; // Return true for dark colors
        }

        // --- Palette Generation & Display Functions ---

        /**
         * Displays the current content of generatedColorsArray in the UI.
         * @param {HTMLElement} container - The HTML element where colors should be displayed.
         */
        function displayCurrentPalette(container) {
            container.innerHTML = ''; // Clear existing colors
            if (generatedColorsArray.length === 0) {
                container.textContent = "No colors generated yet. Generate a palette!";
                container.classList.add('text-center', 'text-gray-500', 'py-4');
                return;
            }
            container.classList.remove('text-center', 'text-gray-500', 'py-4'); // Remove classes if content exists

            generatedColorsArray.forEach(item => {
                const colorBox = document.createElement('div');
                colorBox.className = 'color-box flex flex-col justify-center items-center p-4';

                let displayHexOrInfo = '';
                let textColorForDisplay = '';

                if (item.type === 'solid') {
                    displayHexOrInfo = item.value;
                    colorBox.style.backgroundColor = item.value;
                    textColorForDisplay = isDarkColor(item.value) ? '#ffffff' : '#333333';
                    colorBox.style.color = textColorForDisplay;

                    colorBox.innerHTML = `
                        <span class="text-xl sm:text-2xl mb-2">${displayHexOrInfo}</span>
                        <span class="text-sm opacity-80">Click to copy</span>
                    `;
                    // Click event for copying solid color
                    colorBox.addEventListener('click', () => {
                        copyToClipboard(item.value);
                    });
                } else if (item.type === 'gradient') {
                    displayHexOrInfo = `${item.start} to ${item.end}`;
                    // For on-screen display, create a small gradient background for the box
                    colorBox.style.background = `linear-gradient(to right, ${item.start}, ${item.end})`;
                    // For gradients, ensure text is readable regardless of background mixture
                    textColorForDisplay = '#333333'; // Often dark text works well on gradients
                    colorBox.style.color = textColorForDisplay;

                    colorBox.innerHTML = `
                        <span class="text-xl sm:text-2xl mb-1 font-semibold text-black-800">Gradient</span>
                        <span class="text-sm text-gray-700 opacity-90">${item.start}</span>
                        <span class="text-sm text-gray-700 opacity-90">${item.end}</span>
                        <span class="text-xs text-gray-600 opacity-70 mt-1">Click to copy info</span>
                    `;
                    // Click event for copying gradient info
                    colorBox.addEventListener('click', () => {
                        copyToClipboard(`Gradient: ${item.start} to ${item.end}`);
                    });
                }
                container.appendChild(colorBox);
            });
        }

        /**
         * Generates a palette with random colors.
         */
        function generateRandomPaletteFromInput() {
            generatedColorsArray = []; // Clear previous colors
            const numColors = parseInt(numColorsRandomInput.value);
            const useTrulyRandom = trulyRandomColorsRandomCheckbox.checked;

            if (isNaN(numColors) || numColors < 1) {
                showModal("Please enter a positive number for the number of colors.");
                numColorsRandomInput.value = 5; // Reset to default if invalid
                return;
            }

            for (let i = 0; i < numColors; i++) {
                if (useTrulyRandom) {
                    generatedColorsArray.push({ type: 'solid', value: getTrulyRandomColor() });
                } else {
                    generatedColorsArray.push({ type: 'solid', value: getEvenlyDistributedRandomColor(i, numColors) });
                }
            }
            displayCurrentPalette(paletteContainerRandom);
        }

        /**
         * Generates a palette with nature-inspired colors.
         */
        function generateNaturePaletteFromInput() {
            generatedColorsArray = []; // Clear previous colors
            const numColors = parseInt(numColorsNatureInput.value);
            const randomizeOrder = randomizeNatureOrderCheckbox.checked;

            if (isNaN(numColors) || numColors < 1) {
                showModal("Please enter a positive number for the number of colors.");
                numColorsNatureInput.value = 5; // Reset to default if invalid
                return;
            }

            let selectedNatureColors = [];
            for (let i = 0; i < numColors; i++) {
                const randomIndex = Math.floor(Math.random() * natureColors.length);
                selectedNatureColors.push(natureColors[randomIndex]);
            }

            if (randomizeOrder) {
                shuffleArray(selectedNatureColors);
            }

            selectedNatureColors.forEach(color => {
                generatedColorsArray.push({ type: 'solid', value: color });
            });

            displayCurrentPalette(paletteContainerNature);
        }

        /**
         * Updates the inline canvas preview for a custom color/gradient input.
         * @param {HTMLElement} inputDiv - The div containing the color/gradient inputs and canvas.
         */
        function updateCustomInputPreview(inputDiv) {
            const canvas = inputDiv.querySelector('.color-preview-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear previous drawing

            const type = inputDiv.dataset.type;

            if (type === 'solid') {
                const colorInput = inputDiv.querySelector('input[type="color"]');
                if (colorInput) {
                    ctx.fillStyle = colorInput.value;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
            } else if (type === 'gradient') {
                const startColorInput = inputDiv.querySelector('input[id$="-start-color"]');
                const endColorInput = inputDiv.querySelector('input[id$="-end-color"]');
                if (startColorInput && endColorInput) {
                    const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
                    gradient.addColorStop(0, startColorInput.value);
                    gradient.addColorStop(1, endColorInput.value);
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
            }
        }


        /**
         * Adds a new solid color input row to the custom palette editor.
         */
        function addCustomColorInput() {
            customInputCounter++;
            const inputId = `custom-solid-${customInputCounter}`;
            const div = document.createElement('div');
            div.className = 'draggable-item flex flex-wrap items-center gap-2 p-2 bg-white border border-gray-200 rounded-lg shadow-sm';
            div.draggable = true;
            div.dataset.type = 'solid';
            div.dataset.id = inputId; // Store unique ID

            div.innerHTML = `
                <span class="drag-handle cursor-grab text-gray-500 mr-2">⠿</span> <!-- Drag handle -->
                <label for="${inputId}-color" class="text-gray-700 whitespace-nowrap">Solid Color:</label>
                <input type="color" id="${inputId}-color" value="#1DA1F2" class="flex-shrink-0">
                <input type="text" id="${inputId}-hex" value="#1DA1F2"
                       class="flex-grow p-2 border border-gray-300 rounded-lg text-sm font-mono"
                       pattern="^#[0-9a-fA-F]{6}$" title="Hex code, e.g., #RRGGBB">
                <canvas class="color-preview-canvas ml-auto rounded" width="40" height="32"></canvas> <!-- Inline preview -->
                <button type="button" class="delete-custom-input px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 transition text-sm">Delete</button>
            `;
            customPaletteInputs.appendChild(div);

            // Sync color picker and text input
            const colorInput = div.querySelector(`#${inputId}-color`);
            const hexInput = div.querySelector(`#${inputId}-hex`);

            colorInput.addEventListener('input', (e) => {
                hexInput.value = e.target.value.toUpperCase();
                updateCustomInputPreview(div);
            });
            hexInput.addEventListener('input', (e) => {
                if (/^#[0-9a-fA-F]{6}$/.test(e.target.value)) {
                    colorInput.value = e.target.value;
                    updateCustomInputPreview(div);
                }
            });
            // Initial sync and preview
            hexInput.value = colorInput.value.toUpperCase();
            updateCustomInputPreview(div);

            // Add delete event listener
            div.querySelector('.delete-custom-input').addEventListener('click', () => {
                div.remove();
            });
        }

        /**
         * Adds a new gradient segment input row to the custom palette editor.
         */
        function addCustomGradientInput() {
            customInputCounter++;
            const inputId = `custom-gradient-${customInputCounter}`;
            const div = document.createElement('div');
            div.className = 'draggable-item flex flex-wrap items-center gap-2 p-2 bg-white border border-gray-200 rounded-lg shadow-sm';
            div.draggable = true;
            div.dataset.type = 'gradient';
            div.dataset.id = inputId; // Store unique ID

            div.innerHTML = `
                <span class="drag-handle cursor-grab text-gray-500 mr-2">⠿</span> <!-- Drag handle -->
                <label for="${inputId}-start-color" class="text-gray-700 whitespace-nowrap">Gradient (Start-End):</label>
                <input type="color" id="${inputId}-start-color" value="#FF0000" class="flex-shrink-0">
                <input type="text" id="${inputId}-start-hex" value="#FF0000"
                       class="w-20 p-2 border border-gray-300 rounded-lg text-sm font-mono"
                       pattern="^#[0-9a-fA-F]{6}$" title="Hex code, e.g., #RRGGBB">
                <span>-</span>
                <input type="color" id="${inputId}-end-color" value="#0000FF" class="flex-shrink-0">
                <input type="text" id="${inputId}-end-hex" value="#0000FF"
                       class="w-20 p-2 border border-gray-300 rounded-lg text-sm font-mono"
                       pattern="^#[0-9a-fA-F]{6}$" title="Hex code, e.g., #RRGGBB">
                <canvas class="color-preview-canvas ml-auto rounded" width="40" height="32"></canvas> <!-- Inline preview -->
                <button type="button" class="delete-custom-input px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 transition text-sm">Delete</button>
            `;
            customPaletteInputs.appendChild(div);

            // Sync color pickers and text inputs
            const startColorInput = div.querySelector(`#${inputId}-start-color`);
            const startHexInput = div.querySelector(`#${inputId}-start-hex`);
            const endColorInput = div.querySelector(`#${inputId}-end-color`);
            const endHexInput = div.querySelector(`#${inputId}-end-hex`);

            startColorInput.addEventListener('input', (e) => {
                startHexInput.value = e.target.value.toUpperCase();
                updateCustomInputPreview(div);
            });
            startHexInput.addEventListener('input', (e) => {
                if (/^#[0-9a-fA-F]{6}$/.test(e.target.value)) {
                    startColorInput.value = e.target.value;
                    updateCustomInputPreview(div);
                }
            });

            endColorInput.addEventListener('input', (e) => {
                endHexInput.value = e.target.value.toUpperCase();
                updateCustomInputPreview(div);
            });
            endHexInput.addEventListener('input', (e) => {
                if (/^#[0-9a-fA-F]{6}$/.test(e.target.value)) {
                    endColorInput.value = e.target.value;
                    updateCustomInputPreview(div);
                }
            });
            // Initial sync and preview
            startHexInput.value = startColorInput.value.toUpperCase();
            endHexInput.value = endColorInput.value.toUpperCase();
            updateCustomInputPreview(div);

            // Add delete event listener
            div.querySelector('.delete-custom-input').addEventListener('click', () => {
                div.remove();
            });
        }

        /**
         * Generates a palette from the custom inputs provided by the user.
         */
        function generateCustomPaletteFromInput() {
            generatedColorsArray = []; // Clear previous colors
            const customEntries = customPaletteInputs.querySelectorAll('.draggable-item'); // Get all draggable items

            if (customEntries.length === 0) {
                showModal("Please add some solid colors or gradient segments to your custom palette first.");
                displayCurrentPalette(paletteContainerCustom); // Still display empty message
                return;
            }

            let hasInvalidInput = false;
            customEntries.forEach(entryDiv => {
                const type = entryDiv.dataset.type;

                if (type === 'solid') {
                    const colorInput = entryDiv.querySelector('input[type="color"][id$="-color"]');
                    const hexValue = colorInput ? colorInput.value : null;
                    if (hexValue && /^#[0-9a-fA-F]{6}$/.test(hexValue)) {
                        generatedColorsArray.push({ type: 'solid', value: hexValue.toUpperCase() });
                    } else {
                        showModal(`Invalid hex code for a solid color: ${hexValue}. Please correct it.`);
                        hasInvalidInput = true;
                    }
                } else if (type === 'gradient') {
                    const startColorInput = entryDiv.querySelector('input[type="color"][id$="-start-color"]');
                    const endColorInput = entryDiv.querySelector('input[type="color"][id$="-end-color"]');
                    const startHex = startColorInput ? startColorInput.value : null;
                    const endHex = endColorInput ? endColorInput.value : null;

                    if (startHex && endHex && /^#[0-9a-fA-F]{6}$/.test(startHex) && /^#[0-9a-fA-F]{6}$/.test(endHex)) {
                        generatedColorsArray.push({ type: 'gradient', start: startHex.toUpperCase(), end: endHex.toUpperCase() });
                    } else {
                        showModal(`Invalid hex code for a gradient segment: Start: ${startHex}, End: ${endHex}. Please correct it.`);
                        hasInvalidInput = true;
                    }
                }
            });

            if (hasInvalidInput) {
                generatedColorsArray = []; // Clear array if any invalid input was found
            }
            displayCurrentPalette(paletteContainerCustom);
        }

        // --- Image Download Functions (Refactored to take arguments for flexibility) ---

        /**
         * Downloads the current color palette as a grid image.
         * @param {HTMLElement} widthInput - The input element for image block width.
         * @param {HTMLElement} heightInput - The input element for image block height.
         * @param {HTMLElement} columnsInput - The input element for columns per row.
         * @param {HTMLElement} hideHexCheckbox - The checkbox element for hiding hex codes.
         */
        function downloadPaletteAsGridImage(widthInput, heightInput, columnsInput, hideHexCheckbox) {
            if (generatedColorsArray.length === 0) {
                showModal("Please generate a color palette first!");
                return;
            }

            // Get user-defined box dimensions and columns, or use defaults
            const boxWidth = parseInt(widthInput.value) || 200;
            const boxHeight = parseInt(heightInput.value) || 120;
            const hideHexCodes = hideHexCheckbox.checked;
            const maxColumns = parseInt(columnsInput.value) || 5;

            // Remove max attribute check to allow any resolution, but keep min
            if (boxWidth < 50 || boxHeight < 50) {
                showModal("Image block width and height must be at least 50px.");
                return;
            }
            if (maxColumns < 1) {
                showModal("Columns per row must be at least 1.");
                return;
            }

            const numRows = Math.ceil(generatedColorsArray.length / maxColumns);
            let lastRowItems = generatedColorsArray.length % maxColumns;
            if (lastRowItems === 0 && generatedColorsArray.length > 0) lastRowItems = maxColumns;
            const actualCanvasWidth = (numRows > 1 || lastRowItems === 0) ? maxColumns * boxWidth : generatedColorsArray.length * boxWidth;
            const canvasHeight = numRows * boxHeight;

            const canvas = document.createElement('canvas');
            canvas.width = actualCanvasWidth;
            canvas.height = canvasHeight;
            const ctx = canvas.getContext('2d');

            if (!hideHexCodes) {
                ctx.font = '24px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.shadowColor = 'rgba(0,0,0,0.4)';
                ctx.shadowOffsetX = 1;
                ctx.shadowOffsetY = 1;
                ctx.shadowBlur = 2;
            }

            generatedColorsArray.forEach((item, index) => {
                const col = index % maxColumns;
                const row = Math.floor(index / maxColumns);

                const x = col * boxWidth;
                const y = row * boxHeight;

                if (item.type === 'solid') {
                    ctx.fillStyle = item.value;
                    ctx.fillRect(x, y, boxWidth, boxHeight);

                    if (!hideHexCodes) {
                        const textColor = isDarkColor(item.value) ? '#ffffff' : '#333333';
                        ctx.fillStyle = textColor;
                        ctx.fillText(item.value, x + boxWidth / 2, y + boxHeight / 2);
                    }
                } else if (item.type === 'gradient') {
                    const gradient = ctx.createLinearGradient(x, y, x + boxWidth, y);
                    gradient.addColorStop(0, item.start);
                    gradient.addColorStop(1, item.end);
                    ctx.fillStyle = gradient;
                    ctx.fillRect(x, y, boxWidth, boxHeight);

                    if (!hideHexCodes) {
                        ctx.fillStyle = '#333333';
                        ctx.font = '18px Inter, sans-serif';
                        ctx.fillText('Gradient', x + boxWidth / 2, y + boxHeight / 2 - 15);
                        ctx.font = '14px Inter, sans-serif';
                        ctx.fillText(item.start, x + boxWidth / 2, y + boxHeight / 2 + 5);
                        ctx.fillText(item.end, x + boxWidth / 2, y + boxHeight / 2 + 25);
                        ctx.font = '24px Inter, sans-serif'; // Reset font
                    }
                }
            });

            const link = document.createElement('a');
            link.download = 'color_palette_grid.png';
            link.href = canvas.toDataURL('image/png');
            link.click();

            showModal("Color palette grid image downloaded!");
        }

        /**
         * Downloads the current color palette as a gradient image.
         * @param {HTMLElement} widthInput - The input element for image block width.
         * @param {HTMLElement} heightInput - The input element for image block height.
         * @param {HTMLElement} hideHexCheckbox - The checkbox element for hiding hex codes.
         */
        function downloadPaletteAsGradientImage(widthInput, heightInput, hideHexCheckbox) {
            if (generatedColorsArray.length === 0) {
                showModal("Please generate a color palette first!");
                return;
            }

            const flattenedColors = [];
            generatedColorsArray.forEach(item => {
                if (item.type === 'solid') {
                    flattenedColors.push(item.value);
                } else if (item.type === 'gradient') {
                    flattenedColors.push(item.start);
                    flattenedColors.push(item.end);
                }
            });

            if (flattenedColors.length === 0) {
                 showModal("No valid colors found in the palette to create a gradient image.");
                 return;
            }
            if (flattenedColors.length === 1) {
                showModal("A gradient requires at least two distinct colors. Only one color found. Downloading as a solid block image instead.");
                const singleColor = flattenedColors[0];
                const canvas = document.createElement('canvas');
                canvas.width = parseInt(widthInput.value) * 2 || 400;
                canvas.height = parseInt(heightInput.value) || 120;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = singleColor;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                if (!hideHexCheckbox.checked) {
                    ctx.font = '24px Inter, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.shadowColor = 'rgba(0,0,0,0.4)';
                    ctx.shadowOffsetX = 1;
                    ctx.shadowOffsetY = 1;
                    ctx.shadowBlur = 2;
                    const textColor = isDarkColor(singleColor) ? '#ffffff' : '#333333';
                    ctx.fillStyle = textColor;
                    ctx.fillText(singleColor, canvas.width / 2, canvas.height / 2);
                }
                const link = document.createElement('a');
                link.download = 'single_color_palette.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                return;
            }

            const width = parseInt(widthInput.value) * 5 || 800;
            const height = parseInt(heightInput.value) || 120;
            const hideHexCodes = hideHexCheckbox.checked;

            // Removed max attribute check to allow any resolution, but keep min
            if (width < 50 || height < 50) {
                showModal("Image width and height for gradient must be at least 50px.");
                return;
            }

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');

            const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);

            flattenedColors.forEach((color, index) => {
                const stop = index / (flattenedColors.length - 1);
                gradient.addColorStop(stop, color);
            });

            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (!hideHexCodes && flattenedColors.length > 0) {
                ctx.font = '24px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.shadowColor = 'rgba(0,0,0,0.4)';
                ctx.shadowOffsetX = 1;
                ctx.shadowOffsetY = 1;
                ctx.shadowBlur = 2;

                flattenedColors.forEach((color, index) => {
                    const textX = (index / (flattenedColors.length - 1)) * canvas.width;
                    const textY = canvas.height / 2;

                    const textColor = isDarkColor(color) ? '#ffffff' : '#333333';
                    ctx.fillStyle = textColor;
                    let finalX = textX;
                    if (index === 0) finalX += 20;
                    if (index === flattenedColors.length - 1) finalX -= 20;

                    if (flattenedColors.length <= 8 || (index % (Math.ceil(flattenedColors.length / 8)) === 0)) {
                         ctx.fillText(color, finalX, textY);
                    } else if (flattenedColors.length < 20 && index % 2 === 0) {
                        ctx.fillText(color, finalX, textY);
                    } else if (flattenedColors.length >= 20 && index % 4 === 0) {
                        ctx.fillText(color, finalX, textY);
                    }
                });
            }

            const link = document.createElement('a');
            link.download = 'color_palette_gradient.png';
            link.href = canvas.toDataURL('image/png');
            link.click();

            showModal("Color palette gradient image downloaded!");
        }


        // --- Drag and Drop Logic for Custom Palette ---
        customPaletteInputs.addEventListener('dragstart', (e) => {
            // Only drag elements with 'draggable-item' class
            if (e.target.classList.contains('draggable-item')) {
                draggedItem = e.target;
                e.dataTransfer.effectAllowed = 'move';
                // Using a small transparent GIF as drag image to avoid default browser ghost
                const img = new Image();
                img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                e.dataTransfer.setDragImage(img, 0, 0);
                setTimeout(() => {
                    e.target.classList.add('dragging'); // Add class for visual feedback
                }, 0);
            }
        });

        customPaletteInputs.addEventListener('dragover', (e) => {
            e.preventDefault(); // Allow drop
            if (e.target.closest('.draggable-item') && draggedItem) {
                const targetItem = e.target.closest('.draggable-item');
                if (targetItem !== draggedItem) {
                    const rect = targetItem.getBoundingClientRect();
                    // Determine if dragging over top or bottom half of the target item
                    const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > 0.5;
                    customPaletteInputs.insertBefore(draggedItem, next && targetItem.nextSibling || targetItem);
                }
            }
        });

        customPaletteInputs.addEventListener('dragend', (e) => {
            if (draggedItem) {
                draggedItem.classList.remove('dragging'); // Remove drag feedback class
                draggedItem = null;
            }
        });


        // --- Event Listeners ---
        closeModalButton.addEventListener('click', hideModal);
        window.addEventListener('click', (event) => {
            if (event.target == modal) {
                hideModal();
            }
        });

        // Home Screen Button Listeners
        startRandomButton.addEventListener('click', () => {
            showScreen(randomPaletteSection);
            // Re-generate a palette when entering the section
            generateRandomPaletteFromInput();
        });
        startNatureButton.addEventListener('click', () => {
            showScreen(naturePaletteSection);
            // Re-generate a palette when entering the section
            generateNaturePaletteFromInput();
        });
        startCustomButton.addEventListener('click', () => {
            showScreen(customPaletteSection);
            // For custom, ensure inputs are ready and display existing if any
            generateCustomPaletteFromInput(); // This will display existing or show "no colors"
        });

        // Back to Home Button Listeners (one for each section)
        backToHomeRandom.addEventListener('click', () => showScreen(homeScreen));
        backToHomeNature.addEventListener('click', () => showScreen(homeScreen));
        backToHomeCustom.addEventListener('click', () => showScreen(homeScreen));

        // Random Palette Controls
        generateRandomButton.addEventListener('click', generateRandomPaletteFromInput);
        downloadPaletteButtonRandom.addEventListener('click', () =>
            downloadPaletteAsGridImage(imageBoxWidthInputRandom, imageBoxHeightInputRandom, imageColumnsInputRandom, hideHexCodesCheckboxRandom)
        );
        downloadGradientButtonRandom.addEventListener('click', () =>
            downloadPaletteAsGradientImage(imageBoxWidthInputRandom, imageBoxHeightInputRandom, hideHexCodesCheckboxRandom)
        );

        // Nature Palette Controls
        generateNatureButton.addEventListener('click', generateNaturePaletteFromInput);
        downloadPaletteButtonNature.addEventListener('click', () =>
            downloadPaletteAsGridImage(imageBoxWidthInputNature, imageBoxHeightInputNature, imageColumnsInputNature, hideHexCodesCheckboxNature)
        );
        downloadGradientButtonNature.addEventListener('click', () =>
            downloadPaletteAsGradientImage(imageBoxWidthInputNature, imageBoxHeightInputNature, hideHexCodesCheckboxNature)
        );

        // Custom Palette Controls
        addSolidColorButton.addEventListener('click', addCustomColorInput);
        addGradientSegmentButton.addEventListener('click', addCustomGradientInput);
        generateCustomButton.addEventListener('click', generateCustomPaletteFromInput);
        downloadPaletteButtonCustom.addEventListener('click', () =>
            downloadPaletteAsGridImage(imageBoxWidthInputCustom, imageBoxHeightInputCustom, imageColumnsInputCustom, hideHexCodesCheckboxCustom)
        );
        downloadGradientButtonCustom.addEventListener('click', () =>
            downloadPaletteAsGradientImage(imageBoxWidthInputCustom, imageBoxHeightInputCustom, hideHexCodesCheckboxCustom)
        );


        // Initial setup on page load: show home screen and add default custom inputs
        document.addEventListener('DOMContentLoaded', () => {
            showScreen(homeScreen);
            addCustomColorInput(); // Add one default solid color input
            addCustomGradientInput(); // Add one default gradient input
        });
    </script>
</body>
</html>
